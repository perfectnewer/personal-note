<!DOCTYPE html>
<html lang="zh-cn">
<head>

  <meta charset="utf-8" />

  
  <title>pve系列: amd显卡直通</title>

  
  
  <link href="//cdn.jsdelivr.net" rel="dns-prefetch">
  <link href="//cdnjs.cloudflare.com" rel="dns-prefetch">
  
  <link href="//at.alicdn.com" rel="dns-prefetch">
  
  <link href="//fonts.googleapis.com" rel="dns-prefetch">
  <link href="//fonts.gstatic.com" rel="dns-prefetch">
  <link href="///disqus.com" rel="dns-prefetch">
  <link href="//c.disquscdn.com" rel="dns-prefetch">
  
  
  <link href="//hm.baidu.com" rel="dns-prefetch">

  

  
  <meta name="author" content="Simon Wei">
  <meta name="description" content="记录了一下pci passthrough的基本操作，遇到的问题和一些经验
">

  
  
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@gohugoio">
    <meta name="twitter:title" content="pve系列: amd显卡直通">
    <meta name="twitter:description" content="记录了一下pci passthrough的基本操作，遇到的问题和一些经验
">
    <meta name="twitter:image" content="/images/avatar.png">
  

  
  <meta property="og:type" content="article">
  <meta property="og:title" content="pve系列: amd显卡直通">
  <meta property="og:description" content="记录了一下pci passthrough的基本操作，遇到的问题和一些经验
">
  <meta property="og:url" content="https://perfectnewer.github.io/personal-note/post/pve/pci_passthrough_basic/">
  <meta property="og:image" content="/images/avatar.png">




<meta name="generator" content="Hugo 0.111.3">


<link rel="canonical" href="https://perfectnewer.github.io/personal-note/post/pve/pci_passthrough_basic/">

<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="format-detection" content="telephone=no,email=no,adress=no">
<meta http-equiv="Cache-Control" content="no-transform">


<meta name="robots" content="index,follow">
<meta name="referrer" content="origin-when-cross-origin">







<meta name="theme-color" content="#02b875">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="simon&#39;s site">
<meta name="msapplication-tooltip" content="simon&#39;s site">
<meta name='msapplication-navbutton-color' content="#02b875">
<meta name="msapplication-TileColor" content="#02b875">
<meta name="msapplication-TileImage" content="/icons/icon-144x144.png">
<link rel="icon" href="https://perfectnewer.github.io/personal-note/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://perfectnewer.github.io/personal-note/icons/icon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://perfectnewer.github.io/personal-note/icons/icon-32x32.png">
<link rel="icon" sizes="192x192" href="https://perfectnewer.github.io/personal-note/icons/icon-192x192.png">
<link rel="apple-touch-icon" href="https://perfectnewer.github.io/personal-note/icons/icon-152x152.png">
<link rel="manifest" href="https://perfectnewer.github.io/personal-note/manifest.json">


<link rel="preload" href="https://perfectnewer.github.io/personal-note/styles/main-rendered.min.css" as="style">


<link rel="preload" href="https://fonts.googleapis.com/css?family=Lobster" as="style">
<link rel="preload" href="https://perfectnewer.github.io/personal-note/images/avatar.png" as="image">
<link rel="preload" href="https://perfectnewer.github.io/personal-note/images/grey-prism.svg" as="image">


<style>
  body {
    background: rgb(244, 243, 241) url('/images/grey-prism.svg') repeat fixed;
  }
</style>
<link rel="stylesheet" href="https://perfectnewer.github.io/personal-note/styles/main-rendered.min.css">


<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lobster">



<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.2/dist/medium-zoom.min.js"></script>




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/video.js@7.3.0/dist/video-js.min.css">



  
  
<!--[if lte IE 8]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-ie8@1.1.2/dist/videojs-ie8.min.js"></script>
<![endif]-->

<!--[if lte IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/eligrey-classlist-js-polyfill@1.2.20180112/classList.min.js"></script>
<![endif]-->


</head>
  <body>
    <div class="suspension">
      <a role="button" aria-label="Go to top" title="Go to top" class="to-top is-hide"><span class="icon icon-up" aria-hidden="true"></span></a>
      
        
	<a role="button" aria-label="Go to comments" title="Go to comments" class="to-comment" href="#disqus_thread"><span class="icon icon-comment" aria-hidden="true"></span></a>
        
      
    </div>
    
    
  <header class="site-header">
  <a href="https://perfectnewer.github.io/personal-note/"><img class="avatar" src="https://perfectnewer.github.io/personal-note/images/avatar.png" alt="Avatar"></a>
  
  <h2 class="title"><a href="https://perfectnewer.github.io/personal-note/">simon&#39;s site</a></h2>
  
  <p class="subtitle">~ the world is so great ~</p>
  <button class="menu-toggle" type="button" aria-label="Main Menu" aria-expanded="false" tab-index="0">
    <span class="icon icon-menu" aria-hidden="true"></span>
  </button>

  <nav class="site-menu collapsed">
    <h2 class="offscreen">Main Menu</h2>
    <ul class="menu-list">
      
      
      
      
        <li class="menu-item
          
          
           is-active">
          <a href="https://perfectnewer.github.io/personal-note/post/">Home</a>
        </li>
      
        <li class="menu-item
          
          
          ">
          <a href="https://perfectnewer.github.io/personal-note/post/">Post</a>
        </li>
      
        <li class="menu-item
          
          
          ">
          <a href="https://perfectnewer.github.io/personal-note/archive">Archive</a>
        </li>
      
        <li class="menu-item
          
          
          ">
          <a href="https://perfectnewer.github.io/personal-note/about">About</a>
        </li>
      
        <li class="menu-item
          
          
          ">
          <a href="https://perfectnewer.github.io/personal-note/links/">Links</a>
        </li>
      
        <li class="menu-item
          
          
          ">
          <a href="https://perfectnewer.github.io/personal-note/tags/">Tags</a>
        </li>
      
    </ul>
  </nav>
  <nav class="social-menu collapsed">
    <h2 class="offscreen">Social Networks</h2>
    <ul class="social-list"><li class="social-item">
          <a href="mailto:weixipeng@outlook.com" title="Email" aria-label="Email">
            <span class="icon icon-email" aria-hidden="true"></span>
          </a>
        </li><li class="social-item">
          <a href="//github.com/perfectnewer" rel="me" title="GitHub" aria-label="GitHub">
	    <span class="icon icon-github" aria-hidden="true"></span>
          </a>
        </li></ul>
  </nav>
</header>

  <section class="main post-detail">
    <header class="post-header">
      <h1 class="post-title">pve系列: amd显卡直通</h1>
      <p class="post-meta">@Simon Wei · Jan 2, 2024 · 5 min read</p>
    </header>
    
      <nav id="TableOfContents">
  <ul>
    <li><a href="#主要参考文章">主要参考文章</a></li>
    <li><a href="#这里说几个注意点">这里说几个注意点</a></li>
    <li><a href="#tested">tested</a></li>
    <li><a href="#pci-passthrough">pci passthrough</a>
      <ul>
        <li><a href="#enable-iommu">enable iommu</a></li>
        <li><a href="#prepare-vfio">prepare vfio</a></li>
        <li><a href="#对于部分amd-gpu">对于部分amd gpu</a></li>
      </ul>
    </li>
    <li><a href="#问题">问题</a>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav>
    <hr style=" border:none; width:100; height:1px;" color=#EBEBEB size=1>
    
    <article class="post-content"><p>记录了一下pci passthrough的基本操作，遇到的问题和一些经验</p>
<p>[TOC]</p>
<h2 id="主要参考文章">主要参考文章</h2>
<p>正常情况下参考以下文章可以顺利直通成功</p>
<ul>
<li><a href="https://pve.proxmox.com/wiki/Pci_passthrough">promox wiki</a></li>
<li><a href="https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF">archwiki pci_passthrough_via_ovmf</a></li>
</ul>
<h2 id="这里说几个注意点">这里说几个注意点</h2>
<ol>
<li>在不同IOMMU groups内的设备直通是互不1影响的，可以在直通页面选择all functions，否则千万不要选all functions。不然相关设备在主机上都无法使用。</li>
<li>pci直通页面rombar选项的作用是把vbios暴露给虚拟机，相当于自己放了romfile。不过对于核显，貌似得自己去主板bios文件中提取vbios，用romfile参数传递</li>
<li>部分amd有reset bug，需要使用第三方补丁：<a href="https://github.com/gnif/vendor-reset">vender_reset</a></li>
<li>部分amd核显也有reset bug，不过上面的补丁不行，得用其他办法，后面再讲</li>
<li>kernel command line中的参数，多余的不会有影响，只要没有错误的就行</li>
</ol>
<h2 id="tested">tested</h2>
<ul>
<li>cpu：5700x，5900，5700g</li>
<li>mother board：asus b550xe，asus b550i</li>
<li>graphics card：5700g，rx580，arc a770</li>
<li>system：pve7.3，pve8.1</li>
<li>machine type：q35， 7.1-8.1</li>
</ul>
<h2 id="pci-passthrough">pci passthrough</h2>
<h3 id="enable-iommu">enable iommu</h3>
<p>bios 开启iommu和虚拟化，对于amd用户</p>
<p>enable IOMMU, SVM; disable CSM</p>
<h5 id="add-kernel-parameter">add kernel parameter</h5>
<p>在 <code>/etc/default/grub</code> 的<code>GRUB_CMDLINE_LINUX_DEFAULT</code> 添加 <code>amd_iommu=on iommu=pt</code><br>
如果没有核显额外添加 <code>initcall_blacklist=sysfb_init</code>，主要作用是禁止framebuffer加载显卡驱动，占用显卡，造成直通失败。不加也可以在启动虚拟机前，卸载掉framebuffer驱动。这样没有核显的情况下，显示器会没有后续日志输出，也不能使用键盘输入。目前可以先不加，先做直通前的准备工作，文件例子：</p>
<pre tabindex="0"><code># If you change this file, run &#39;update-grub&#39; afterwards to update
# /boot/grub/grub.cfg.
# For full documentation of the options in this file, see:
#   info -f grub -n &#39;Simple configuration&#39;

GRUB_DEFAULT=0
GRUB_TIMEOUT=3
GRUB_DISTRIBUTOR=`lsb_release -i -s 2&gt; /dev/null || echo Debian`
GRUB_CMDLINE_LINUX_DEFAULT=&#34;iommu=pt amd_iommu=on amdgpu.noretry=0 pcie_acs_override=downstream,multifunction&#34;
GRUB_CMDLINE_LINUX=&#34;&#34;

# If your computer has multiple operating systems installed, then you
# probably want to run os-prober. However, if your computer is a host
# for guest OSes installed via LVM or raw disk devices, running
# os-prober can cause damage to those guest OSes as it mounts
# filesystems to look for things.
#GRUB_DISABLE_OS_PROBER=false

# Uncomment to enable BadRAM filtering, modify to suit your needs
# This works with Linux (no patch required) and with any kernel that obtains
# the memory map information from GRUB (GNU Mach, kernel of FreeBSD ...)
#GRUB_BADRAM=&#34;0x01234567,0xfefefefe,0x89abcdef,0xefefefef&#34;

# Uncomment to disable graphical terminal
#GRUB_TERMINAL=console

# The resolution used on graphical terminal
# note that you can use only modes which your graphic card supports via VBE
# you can see them in real GRUB with the command `vbeinfo&#39;
#GRUB_GFXMODE=640x480

# Uncomment if you don&#39;t want GRUB to pass &#34;root=UUID=xxx&#34; parameter to Linux
#GRUB_DISABLE_LINUX_UUID=true

# Uncomment to disable generation of recovery mode menu entries
#GRUB_DISABLE_RECOVERY=&#34;true&#34;

# Uncomment to get a beep at grub start
#GRUB_INIT_TUNE=&#34;480 440 1&#34;
</code></pre><p>然后更新grub.cfg,重启：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo update-grub
</span></span><span style="display:flex;"><span>sudo reboot
</span></span></code></pre></div><h4 id="开机后检查iommu状态">开机后检查iommu状态：</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># dmesg | grep -e DMAR -e IOMMU</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.000000<span style="color:#f92672">]</span> Warning: PCIe ACS overrides enabled; This may allow non-IOMMU protected peer-to-peer DMA
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.507259<span style="color:#f92672">]</span> pci 0000:00:00.2: AMD-Vi: IOMMU performance counters supported
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.508883<span style="color:#f92672">]</span> pci 0000:00:00.2: AMD-Vi: Found IOMMU cap 0x40
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.528883<span style="color:#f92672">]</span> perf/amd_iommu: Detected AMD IOMMU <span style="color:#75715e">#0 (2 banks, 4 counters/bank).</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>   10.196349<span style="color:#f92672">]</span> AMD-Vi: AMD IOMMUv2 loaded and initialized
</span></span></code></pre></div><p>输出中有 &ldquo;DMAR: IOMMU enabled&rdquo; 或者 &ldquo;AMD-Vi: AMD IOMMUv2 loaded and initialized&rdquo; 表示开启成功，如果没有那么需要查一下资料确认已经开启成功了</p>
<h4 id="确认--iommu-interrupt-remapping">确认  IOMMU interrupt remapping</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>dmesg | grep <span style="color:#e6db74">&#39;remapping&#39;</span>
</span></span></code></pre></div><p>如果有下面任一输出，说明支持remapping</p>
<pre tabindex="0"><code>AMD-Vi: Interrupt remapping enabled
DMAR-IR: Enabled IRQ remapping in x2apic mode (&#39;x2apic&#39; can be different on old CPUs, but should still work)
then remapping is supported.
</code></pre><p>否则要加入以下配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;options vfio_iommu_type1 allow_unsafe_interrupts=1&#34;</span> &gt; /etc/modprobe.d/iommu_unsafe_interrupts.conf
</span></span></code></pre></div><h3 id="prepare-vfio">prepare vfio</h3>
<h4 id="让系统加载vfio驱动">让系统加载vfio驱动</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt; EOF &gt;&gt; /etc/modules 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vfio
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vfio_iommu_type1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vfio_pci
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vfio_virqfd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>update-initramfs -u
</span></span></code></pre></div><h4 id="用vfio代替原驱动">用vfio代替原驱动</h4>
<p>这里有两个方案，一个是系统启动时直接替换。一种是启动虚拟机时按需替换，如果有核显可用或者不需要显示物理机画面，可以直接配置成启动时替换</p>
<h6 id="配置vfio加载优先">配置vfio加载优先</h6>
<p>查看需要直通的设备使用了什么驱动 根据驱动情况调整</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@pve:~# lspci -nnk -s 0b:00
</span></span><span style="display:flex;"><span>0b:00.0 VGA compatible controller <span style="color:#f92672">[</span>0300<span style="color:#f92672">]</span>: Advanced Micro Devices, Inc. <span style="color:#f92672">[</span>AMD/ATI<span style="color:#f92672">]</span> Cezanne <span style="color:#f92672">[</span>Radeon Vega Series / Radeon Vega Mobile Series<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1002:1638<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>rev c8<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	Subsystem: ASUSTeK Computer Inc. Cezanne <span style="color:#f92672">[</span>Radeon Vega Series / Radeon Vega Mobile Series<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1043:8809<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	Kernel driver in use: amdgpu
</span></span><span style="display:flex;"><span>	Kernel modules: amdgpu
</span></span><span style="display:flex;"><span>0b:00.1 Audio device <span style="color:#f92672">[</span>0403<span style="color:#f92672">]</span>: Advanced Micro Devices, Inc. <span style="color:#f92672">[</span>AMD/ATI<span style="color:#f92672">]</span> Renoir Radeon High Definition Audio Controller <span style="color:#f92672">[</span>1002:1637<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	Subsystem: ASUSTeK Computer Inc. Renoir Radeon High Definition Audio Controller <span style="color:#f92672">[</span>1043:8809<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	Kernel driver in use: snd_hda_intel
</span></span><span style="display:flex;"><span>	Kernel modules: snd_hda_intel
</span></span><span style="display:flex;"><span>0b:00.2 Encryption controller <span style="color:#f92672">[</span>1080<span style="color:#f92672">]</span>: Advanced Micro Devices, Inc. <span style="color:#f92672">[</span>AMD<span style="color:#f92672">]</span> Family 17h <span style="color:#f92672">(</span>Models 10h-1fh<span style="color:#f92672">)</span> Platform Security Processor <span style="color:#f92672">[</span>1022:15df<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	Subsystem: ASUSTeK Computer Inc. Family 17h <span style="color:#f92672">(</span>Models 10h-1fh<span style="color:#f92672">)</span> Platform Security Processor <span style="color:#f92672">[</span>1043:8809<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	Kernel driver in use: ccp
</span></span><span style="display:flex;"><span>	Kernel modules: ccp
</span></span><span style="display:flex;"><span>0b:00.3 USB controller <span style="color:#f92672">[</span>0c03<span style="color:#f92672">]</span>: Advanced Micro Devices, Inc. <span style="color:#f92672">[</span>AMD<span style="color:#f92672">]</span> Renoir/Cezanne USB 3.1 <span style="color:#f92672">[</span>1022:1639<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	Subsystem: ASUSTeK Computer Inc. Renoir/Cezanne USB 3.1 <span style="color:#f92672">[</span>1043:87e1<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	Kernel driver in use: xhci_hcd
</span></span><span style="display:flex;"><span>	Kernel modules: xhci_pci
</span></span><span style="display:flex;"><span>0b:00.4 USB controller <span style="color:#f92672">[</span>0c03<span style="color:#f92672">]</span>: Advanced Micro Devices, Inc. <span style="color:#f92672">[</span>AMD<span style="color:#f92672">]</span> Renoir/Cezanne USB 3.1 <span style="color:#f92672">[</span>1022:1639<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	Subsystem: ASUSTeK Computer Inc. Renoir/Cezanne USB 3.1 <span style="color:#f92672">[</span>1043:87e1<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	Kernel driver in use: xhci_hcd
</span></span><span style="display:flex;"><span>	Kernel modules: xhci_pci
</span></span><span style="display:flex;"><span>0b:00.6 Audio device <span style="color:#f92672">[</span>0403<span style="color:#f92672">]</span>: Advanced Micro Devices, Inc. <span style="color:#f92672">[</span>AMD<span style="color:#f92672">]</span> Family 17h/19h HD Audio Controller <span style="color:#f92672">[</span>1022:15e3<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	Subsystem: ASUSTeK Computer Inc. Family 17h/19h HD Audio Controller <span style="color:#f92672">[</span>1043:87d3<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	Kernel driver in use: snd_hda_intel
</span></span><span style="display:flex;"><span>	Kernel modules: snd_hda_intel
</span></span></code></pre></div><p>比如上面的vega核显，看Kernel driver inuse那张，表明使用的是amdgopu，然后配置vfio优先加载，这个加载文件并不影响驱动使用，就是说，如果你打算虚拟机启动的时候才直通，不启动的时候物理机仍然可以使用，也能加</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt; EOF &gt;&gt; /etc/modprobe.d/01-vfio-pci.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># amd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">softdep radeon pre: vfio-pci
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">softdep nouveau pre: vfio-pci
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">softdep amdgpu pre: vfio-pci
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">softdep snd_hda_intel pre: vfio-pci
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><h6 id="配置vfio直通的设备id">配置vfio直通的设备id</h6>
<p>找到要直通的设备标识 vender_id:device_id</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># find vga pci</span>
</span></span><span style="display:flex;"><span>lspci -k | grep -A10 VGA
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lspci -n -s &lt;VGAID:eg 07:00&gt; | awk <span style="color:#e6db74">&#39;{print $3}&#39;</span>
</span></span></code></pre></div><p>加入到vfio的配置中
方法1：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;options vfio-pci ids=1002:67df,1002:aaf0 disable_vga=1&#34;</span> &gt;&gt; /etc/modprobe.d/vfio.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>update-initramfs -u
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>reboot
</span></span></code></pre></div><p>方法2：也可以使用kernel command line，我比较喜欢这种方式。因为如果出问题了，可以在grub界面删掉，正常进系统补救。不然就只能ssh登录进行补救了</p>
<p>修改/etc/default/grub在GRUB_CMDLINE_LINUX_DEFAULT中加上<code>vfio-pci.ids=8086:56a0,8086:4f90 vfio-pci.disable_vga=1</code>, l例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>GRUB_CMDLINE_LINUX_DEFAULT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;iommu=pt amd_iommu=on amdgpu.noretry=0 pcie_acs_override=downstream,multifunction vfio-pci.ids=8086:56a0,8086:4f90 vfio-pci.disable_vga=1&#34;</span>
</span></span></code></pre></div><p>然后更新grub，重启</p>
<pre tabindex="0"><code>update-grub
reboot
</code></pre><h6 id="单显卡直通">单显卡直通</h6>
<p>另开单写</p>
<h5 id="check-vfio">check vfio</h5>
<p>重启后，确认vfio正常加载，想要直通的设备已经使用vfio-pci</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>使用vfio替代驱动。通过lspci -nnk 查看要直通的设备使用了哪些驱动
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># dmesg | grep -i vfio</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.329224<span style="color:#f92672">]</span> VFIO - User Level meta-driver version: 0.3
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.341372<span style="color:#f92672">]</span> vfio_pci: add <span style="color:#f92672">[</span>10de:13c2<span style="color:#f92672">[</span>ffff:ffff<span style="color:#f92672">]]</span> class 0x000000/00000000
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.354704<span style="color:#f92672">]</span> vfio_pci: add <span style="color:#f92672">[</span>10de:0fbb<span style="color:#f92672">[</span>ffff:ffff<span style="color:#f92672">]]</span> class 0x000000/00000000
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    2.061326<span style="color:#f92672">]</span> vfio-pci 0000:06:00.0: enabling device <span style="color:#f92672">(</span><span style="color:#ae81ff">0100</span> -&gt; 0103<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ lspci -nnk -s 07:00
</span></span><span style="display:flex;"><span>07:00.0 VGA compatible controller <span style="color:#f92672">[</span>0300<span style="color:#f92672">]</span>: Advanced Micro Devices, Inc. <span style="color:#f92672">[</span>AMD/ATI<span style="color:#f92672">]</span> Ellesmere <span style="color:#f92672">[</span>Radeon RX 470/480/570/570X/580/580X/590<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1002:67df<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>rev e7<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    Subsystem: Tul Corporation / PowerColor Radeon RX <span style="color:#ae81ff">580</span> <span style="color:#f92672">[</span>148c:2378<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    Kernel driver in use: vfio-pci
</span></span><span style="display:flex;"><span>    Kernel modules: amdgpu
</span></span><span style="display:flex;"><span>07:00.1 Audio device <span style="color:#f92672">[</span>0403<span style="color:#f92672">]</span>: Advanced Micro Devices, Inc. <span style="color:#f92672">[</span>AMD/ATI<span style="color:#f92672">]</span> Ellesmere HDMI Audio <span style="color:#f92672">[</span>Radeon RX 470/480 / 570/580/590<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1002:aaf0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    Subsystem: Tul Corporation / PowerColor Ellesmere HDMI Audio <span style="color:#f92672">[</span>Radeon RX 470/480 / 570/580/590<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>148c:aaf0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    Kernel driver in use: vfio-pci
</span></span><span style="display:flex;"><span>    Kernel modules: snd_hda_intel
</span></span></code></pre></div><h4 id="iommu-group">iommu group</h4>
<p>查看要直通设备的iommu group，要直通的设备最好是在单独的iommu group中。这样虚拟机的pci属性页面可以选择all functions如果内核开启了<code>pcie_acs_override=downstream,multifunction</code>就不要选all functions。除非开启前就是单独的iommu group</p>
<h5 id="查看方法1">查看方法1：</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>shopt -s nullglob
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> g in /sys/kernel/iommu_groups/*; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;IOMMU Group </span><span style="color:#e6db74">${</span>g##*/<span style="color:#e6db74">}</span><span style="color:#e6db74">:&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> d in $g/devices/*; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        echo -e <span style="color:#e6db74">&#34;\t</span><span style="color:#66d9ef">$(</span>lspci -nns <span style="color:#e6db74">${</span>d##*/<span style="color:#e6db74">}</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">done</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>;
</span></span></code></pre></div><h5 id="查看方法2">查看方法2：</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 其中nodename换成节点机器名，单节点就是当前机器名</span>
</span></span><span style="display:flex;"><span>pvesh get /nodes/&lt;nodename&gt;/hardware/pci --pci-class-blacklist <span style="color:#e6db74">&#34;&#34;</span>
</span></span></code></pre></div><h5 id="查看方法3">查看方法3：</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>find /sys/kernel/iommu_groups/ -type l
</span></span></code></pre></div><h5 id="如果想要直通的设备没有在单独的iommu-group中可以添加内核参数">如果想要直通的设备没有在单独的iommu group中，可以添加内核参数</h5>
<p><code>pcie_acs_override=downstream,multifunction</code></p>
<h3 id="对于部分amd-gpu">对于部分amd gpu</h3>
<ul>
<li>AMD	Polaris 10	RX 470, 480, 570, 580, 590</li>
<li>AMD	Polaris 11	RX 460, 560</li>
<li>AMD	Polaris 12	RX 540, 550</li>
<li>AMD	Vega 10	Vega 56/64/FE</li>
<li>AMD	Vega 20	Radeon VII</li>
<li>AMD	Navi 10	5600XT, 5700, 5700XT</li>
<li>AMD	Navi 12	Pro 5600M</li>
<li>AMD	Navi 14	Pro 5300, RX 5300, 5500XT</li>
</ul>
<p>使用第三方补丁，修复reset bug
<a href="https://github.com/gnif/vendor-reset">vender_reset</a></p>
<p>对于amd 5000系带核显的cpu，要直通的话。</p>
<ol>
<li>不要重启虚拟机，不然除非重启物理机，不然核显无法再次被虚拟机识别</li>
<li>虚拟机关机前在设备管理器中卸载核显</li>
<li>windows虚拟机中使用：<a href="https://github.com/inga-lovinde/RadeonResetBugFix">RadeonResetBugFix</a></li>
</ol>
<h5 id="amd核显直通">amd核显直通</h5>
<p>后续单开文章</p>
<h2 id="问题">问题</h2>
<h4 id="vfio-pci--cant-reserve-mem">vfio-pci &hellip; can&rsquo;t reserve [mem</h4>
<pre tabindex="0"><code>[ 764.499088] vfio-pci 0000:07:00.0: BAR 1: can&#39;t reserve [mem 0x7ff0000000-0x7ff7ffffff 64bit pref]
</code></pre><p>添加内核参数<code>video=efifb:off</code> 或者 <code>initcall_blacklist=sysfb_init</code></p>
<hr>
<p><!-- raw HTML omitted -->我的github pages: <a href="https://perfectnewer.github.io">perfectnewer.gitub.io</a>
<!-- raw HTML omitted -->我的gitee pages: <a href="https://perfectnewer.gitee.io">perfectnewer.gitee.io</a></p></article>
    <footer class="post-footer">
      
      <ul class="post-tags">
        
          <li><a href="https://perfectnewer.github.io/personal-note/tags/pve"><span class="tag">Pve</span></a></li>
        
          <li><a href="https://perfectnewer.github.io/personal-note/tags/pci-passthrough"><span class="tag">Pci Passthrough</span></a></li>
        
      </ul>
      
      <p class="post-copyright">
        © This post is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License，please give source if you wish to quote or reproduce.
      </p>
    </footer>
    
      <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "simon_wei" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
    
  </section>

  <aside id="meta">
    <div>
    <section>
      <h4 id="date"> Tue Jan 2, 2024 </h4>
      <h5 id="wordcount"> 967 Words </h5>
    </section>
    
    
    <ul id="tags">
      
        <li> <a href="https://perfectnewer.github.io/personal-note/tagspve">pve</a> </li>
      
        <li> <a href="https://perfectnewer.github.io/personal-note/tagspci-passthrough">pci passthrough</a> </li>
      
    </ul>
    
    </div>
    <div>
        
          <a class="previous" href="https://perfectnewer.github.io/personal-note/post/pve/hostonly/"> pve 内部网络：添加hostonly网络</a>
        
        
    </div>
</aside>

  
<footer class="site-footer">
  <p>© 2017-2024 simon&#39;s site</p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> with theme <a href="https://github.com/laozhu/hugo-nuo" target="_blank" rel="noopener">Nuo</a>.</p>
  
</footer>


<script src="https://cdn.jsdelivr.net/npm/smooth-scroll@15.0.0/dist/smooth-scroll.min.js"></script>



<script async src="https://cdn.jsdelivr.net/npm/video.js@7.3.0/dist/video.min.js"></script>




<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    },
  });
</script>
<script type="text/x-mathjax-config">
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script>



<script src="https://perfectnewer.github.io/personal-note/scripts/index.min.js"></script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('\/service-worker.js').then(function() {
      console.log('[ServiceWorker] Registered');
    });
  }
</script>






<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?8467334201490ae35c81ff7d32d009ff";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>



  </body>
</html>
